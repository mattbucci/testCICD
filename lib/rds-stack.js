"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RDSStack = void 0;
const core_1 = require("@aws-cdk/core");
const aws_rds_1 = require("@aws-cdk/aws-rds");
const aws_secretsmanager_1 = require("@aws-cdk/aws-secretsmanager");
const aws_ec2_1 = require("@aws-cdk/aws-ec2");
class RDSStack extends core_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.secret = new aws_secretsmanager_1.Secret(this, `wordpress_database_password`, {
            generateSecretString: {
                excludePunctuation: true
            }
        });
        this.credentials = aws_rds_1.Credentials.fromUsername(`wordpress_admin`, { password: this.secret.secretValue });
        // this.database = config.appName; // maybe use different name
        this.database = "Wordpress";
        this.databaseAccessSecurityGroup = new aws_ec2_1.SecurityGroup(this, 'rds-security-group', {
            vpc: props.vpc,
            allowAllOutbound: false,
            securityGroupName: 'RDSSecurityGroup',
        });
        var inboundDbAccessSecurityGroup = new aws_ec2_1.SecurityGroup(this, 'ingress-security-group', {
            vpc: props.vpc,
            allowAllOutbound: false,
            securityGroupName: 'IngressSecurityGroup',
        });
        this.databaseAccessSecurityGroup.addEgressRule(inboundDbAccessSecurityGroup, aws_ec2_1.Port.tcp(3306));
        inboundDbAccessSecurityGroup.addIngressRule(this.databaseAccessSecurityGroup, aws_ec2_1.Port.tcp(3306));
        this.mySQLRDSInstance = new aws_rds_1.DatabaseInstance(this, 'mysql-rds-instance', {
            engine: aws_rds_1.DatabaseInstanceEngine.MYSQL,
            instanceType: aws_ec2_1.InstanceType.of(aws_ec2_1.InstanceClass.T2, aws_ec2_1.InstanceSize.SMALL),
            vpc: props.vpc,
            vpcPlacement: { subnetType: aws_ec2_1.SubnetType.PRIVATE },
            storageEncrypted: true,
            multiAz: false,
            autoMinorVersionUpgrade: true,
            allocatedStorage: 25,
            storageType: aws_rds_1.StorageType.GP2,
            backupRetention: core_1.Duration.days(3),
            deletionProtection: false,
            credentials: this.credentials,
            databaseName: this.database,
            securityGroups: [inboundDbAccessSecurityGroup],
            port: 3306
        });
    }
}
exports.RDSStack = RDSStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmRzLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmRzLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHdDQUE4RTtBQUM5RSw4Q0FBc0c7QUFDdEcsb0VBQXFGO0FBQ3JGLDhDQUF5SDtBQU96SCxNQUFhLFFBQVMsU0FBUSxZQUFLO0lBUS9CLFlBQVksS0FBVSxFQUFFLEVBQVUsRUFBRSxLQUFvQjtRQUNwRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksMkJBQU0sQ0FBQyxJQUFJLEVBQUUsNkJBQTZCLEVBQUU7WUFDMUQsb0JBQW9CLEVBQUU7Z0JBQ2xCLGtCQUFrQixFQUFFLElBQUk7YUFDM0I7U0FDSixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsV0FBVyxHQUFHLHFCQUFXLENBQUMsWUFBWSxDQUFDLGlCQUFpQixFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUN0Ryw4REFBOEQ7UUFDOUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxXQUFXLENBQUM7UUFDNUIsSUFBSSxDQUFDLDJCQUEyQixHQUFHLElBQUksdUJBQWEsQ0FBQyxJQUFJLEVBQUUsb0JBQW9CLEVBQUU7WUFDN0UsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHO1lBQ2QsZ0JBQWdCLEVBQUUsS0FBSztZQUN2QixpQkFBaUIsRUFBRSxrQkFBa0I7U0FDeEMsQ0FBQyxDQUFDO1FBRUgsSUFBSSw0QkFBNEIsR0FBRyxJQUFJLHVCQUFhLENBQUMsSUFBSSxFQUFFLHdCQUF3QixFQUFFO1lBQ2pGLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRztZQUNkLGdCQUFnQixFQUFFLEtBQUs7WUFDdkIsaUJBQWlCLEVBQUUsc0JBQXNCO1NBQzVDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQywyQkFBMkIsQ0FBQyxhQUFhLENBQUMsNEJBQTRCLEVBQUUsY0FBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzdGLDRCQUE0QixDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLEVBQUUsY0FBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRTlGLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLDBCQUFnQixDQUFDLElBQUksRUFBRSxvQkFBb0IsRUFBRTtZQUNyRSxNQUFNLEVBQUUsZ0NBQXNCLENBQUMsS0FBSztZQUNwQyxZQUFZLEVBQUUsc0JBQVksQ0FBQyxFQUFFLENBQUMsdUJBQWEsQ0FBQyxFQUFFLEVBQUUsc0JBQVksQ0FBQyxLQUFLLENBQUM7WUFDbkUsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHO1lBQ2QsWUFBWSxFQUFFLEVBQUUsVUFBVSxFQUFFLG9CQUFVLENBQUMsT0FBTyxFQUFFO1lBQ2hELGdCQUFnQixFQUFFLElBQUk7WUFDdEIsT0FBTyxFQUFFLEtBQUs7WUFDZCx1QkFBdUIsRUFBRSxJQUFJO1lBQzdCLGdCQUFnQixFQUFFLEVBQUU7WUFDcEIsV0FBVyxFQUFFLHFCQUFXLENBQUMsR0FBRztZQUM1QixlQUFlLEVBQUUsZUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDakMsa0JBQWtCLEVBQUUsS0FBSztZQUN6QixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsWUFBWSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQzNCLGNBQWMsRUFBRSxDQUFDLDRCQUE0QixDQUFDO1lBQzlDLElBQUksRUFBRSxJQUFJO1NBQ2IsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBcERELDRCQW9EQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcCwgRHVyYXRpb24sIFNlY3JldFZhbHVlLCBTdGFjaywgU3RhY2tQcm9wcyB9IGZyb20gXCJAYXdzLWNkay9jb3JlXCI7XG5pbXBvcnQgeyBEYXRhYmFzZUluc3RhbmNlLCBEYXRhYmFzZUluc3RhbmNlRW5naW5lLCBTdG9yYWdlVHlwZSwgQ3JlZGVudGlhbHMgfSBmcm9tICdAYXdzLWNkay9hd3MtcmRzJztcbmltcG9ydCB7IElTZWNyZXQsIFNlY3JldCwgU2VjcmV0U3RyaW5nR2VuZXJhdG9yIH0gZnJvbSAnQGF3cy1jZGsvYXdzLXNlY3JldHNtYW5hZ2VyJztcbmltcG9ydCB7IEluc3RhbmNlQ2xhc3MsIEluc3RhbmNlU2l6ZSwgSW5zdGFuY2VUeXBlLCBQZWVyLCBTZWN1cml0eUdyb3VwLCBTdWJuZXRUeXBlLCBWcGMsIFBvcnQgfSBmcm9tIFwiQGF3cy1jZGsvYXdzLWVjMlwiO1xuaW1wb3J0IGNvbmZpZyBmcm9tICcuLi9jb25maWcnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJEU1N0YWNrUHJvcHMgZXh0ZW5kcyBTdGFja1Byb3BzIHtcbiAgICB2cGM6IFZwYztcbn1cblxuZXhwb3J0IGNsYXNzIFJEU1N0YWNrIGV4dGVuZHMgU3RhY2sge1xuXG4gICAgcmVhZG9ubHkgY3JlZGVudGlhbHM6IENyZWRlbnRpYWxzO1xuICAgIHJlYWRvbmx5IHNlY3JldDogU2VjcmV0XG4gICAgcmVhZG9ubHkgZGF0YWJhc2U6IHN0cmluZztcbiAgICByZWFkb25seSBteVNRTFJEU0luc3RhbmNlOiBEYXRhYmFzZUluc3RhbmNlO1xuICAgIHJlYWRvbmx5IGRhdGFiYXNlQWNjZXNzU2VjdXJpdHlHcm91cDogU2VjdXJpdHlHcm91cFxuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IEFwcCwgaWQ6IHN0cmluZywgcHJvcHM6IFJEU1N0YWNrUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG5cbiAgICAgICAgdGhpcy5zZWNyZXQgPSBuZXcgU2VjcmV0KHRoaXMsIGB3b3JkcHJlc3NfZGF0YWJhc2VfcGFzc3dvcmRgLCB7XG4gICAgICAgICAgICBnZW5lcmF0ZVNlY3JldFN0cmluZzoge1xuICAgICAgICAgICAgICAgIGV4Y2x1ZGVQdW5jdHVhdGlvbjogdHJ1ZVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jcmVkZW50aWFscyA9IENyZWRlbnRpYWxzLmZyb21Vc2VybmFtZShgd29yZHByZXNzX2FkbWluYCwgeyBwYXNzd29yZDogdGhpcy5zZWNyZXQuc2VjcmV0VmFsdWUgfSk7XG4gICAgICAgIC8vIHRoaXMuZGF0YWJhc2UgPSBjb25maWcuYXBwTmFtZTsgLy8gbWF5YmUgdXNlIGRpZmZlcmVudCBuYW1lXG4gICAgICAgIHRoaXMuZGF0YWJhc2UgPSBcIldvcmRwcmVzc1wiO1xuICAgICAgICB0aGlzLmRhdGFiYXNlQWNjZXNzU2VjdXJpdHlHcm91cCA9IG5ldyBTZWN1cml0eUdyb3VwKHRoaXMsICdyZHMtc2VjdXJpdHktZ3JvdXAnLCB7XG4gICAgICAgICAgICB2cGM6IHByb3BzLnZwYyxcbiAgICAgICAgICAgIGFsbG93QWxsT3V0Ym91bmQ6IGZhbHNlLFxuICAgICAgICAgICAgc2VjdXJpdHlHcm91cE5hbWU6ICdSRFNTZWN1cml0eUdyb3VwJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdmFyIGluYm91bmREYkFjY2Vzc1NlY3VyaXR5R3JvdXAgPSBuZXcgU2VjdXJpdHlHcm91cCh0aGlzLCAnaW5ncmVzcy1zZWN1cml0eS1ncm91cCcsIHtcbiAgICAgICAgICAgIHZwYzogcHJvcHMudnBjLFxuICAgICAgICAgICAgYWxsb3dBbGxPdXRib3VuZDogZmFsc2UsXG4gICAgICAgICAgICBzZWN1cml0eUdyb3VwTmFtZTogJ0luZ3Jlc3NTZWN1cml0eUdyb3VwJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5kYXRhYmFzZUFjY2Vzc1NlY3VyaXR5R3JvdXAuYWRkRWdyZXNzUnVsZShpbmJvdW5kRGJBY2Nlc3NTZWN1cml0eUdyb3VwLCBQb3J0LnRjcCgzMzA2KSk7XG4gICAgICAgIGluYm91bmREYkFjY2Vzc1NlY3VyaXR5R3JvdXAuYWRkSW5ncmVzc1J1bGUodGhpcy5kYXRhYmFzZUFjY2Vzc1NlY3VyaXR5R3JvdXAsIFBvcnQudGNwKDMzMDYpKTtcblxuICAgICAgICB0aGlzLm15U1FMUkRTSW5zdGFuY2UgPSBuZXcgRGF0YWJhc2VJbnN0YW5jZSh0aGlzLCAnbXlzcWwtcmRzLWluc3RhbmNlJywge1xuICAgICAgICAgICAgZW5naW5lOiBEYXRhYmFzZUluc3RhbmNlRW5naW5lLk1ZU1FMLFxuICAgICAgICAgICAgaW5zdGFuY2VUeXBlOiBJbnN0YW5jZVR5cGUub2YoSW5zdGFuY2VDbGFzcy5UMiwgSW5zdGFuY2VTaXplLlNNQUxMKSxcbiAgICAgICAgICAgIHZwYzogcHJvcHMudnBjLFxuICAgICAgICAgICAgdnBjUGxhY2VtZW50OiB7IHN1Ym5ldFR5cGU6IFN1Ym5ldFR5cGUuUFJJVkFURSB9LFxuICAgICAgICAgICAgc3RvcmFnZUVuY3J5cHRlZDogdHJ1ZSxcbiAgICAgICAgICAgIG11bHRpQXo6IGZhbHNlLFxuICAgICAgICAgICAgYXV0b01pbm9yVmVyc2lvblVwZ3JhZGU6IHRydWUsXG4gICAgICAgICAgICBhbGxvY2F0ZWRTdG9yYWdlOiAyNSxcbiAgICAgICAgICAgIHN0b3JhZ2VUeXBlOiBTdG9yYWdlVHlwZS5HUDIsXG4gICAgICAgICAgICBiYWNrdXBSZXRlbnRpb246IER1cmF0aW9uLmRheXMoMyksXG4gICAgICAgICAgICBkZWxldGlvblByb3RlY3Rpb246IGZhbHNlLFxuICAgICAgICAgICAgY3JlZGVudGlhbHM6IHRoaXMuY3JlZGVudGlhbHMsXG4gICAgICAgICAgICBkYXRhYmFzZU5hbWU6IHRoaXMuZGF0YWJhc2UsXG4gICAgICAgICAgICBzZWN1cml0eUdyb3VwczogW2luYm91bmREYkFjY2Vzc1NlY3VyaXR5R3JvdXBdLFxuICAgICAgICAgICAgcG9ydDogMzMwNlxuICAgICAgICB9KTtcbiAgICB9XG59Il19